---
import { Icon } from 'astro-icon/components';
import { speakingSessions } from '~/data';
import Layout from '~/layouts/PageLayout.astro';
import type { MetaSEO } from '~/types';
import speakingBanner from 'src/assets/images/banner-speaking.png';

const pageDescription = 'You may have seen me talking about things I like on some occasions';

const meta: MetaSEO = {
  title: 'Public Speaking',
  description: pageDescription,
  image: speakingBanner,
  author: 'Leonardo Montini',
};

const sessionsByYear = speakingSessions
  .toSorted((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
  .reduce((acc, session) => {
    const year = new Date(session.date).getFullYear();
    acc[year] = acc[year] || [];
    acc[year].push(session);
    return acc;
  }, {} as Record<string, typeof speakingSessions>);

const years = Object.keys(sessionsByYear).sort((a, b) => parseInt(b) - parseInt(a));

// Helper function to format date
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

// Helper function to get session icon based on type
const getSessionTypeIcon = (type: 'session' | 'interview') => {
  return type === 'session' ? 'tabler:presentation' : 'tabler:messages';
};

// Helper function to get mode icon
const getModeIcon = (mode: 'in-person' | 'remote' | 'hybrid') => {
  switch (mode) {
    case 'in-person':
      return 'tabler:users';
    case 'remote':
      return 'tabler:device-laptop';
    case 'hybrid':
      return 'tabler:device-laptop-off';
  }
};

// Helper to get color based on session type
const getSessionColor = (type: 'session' | 'interview') => {
  return type === 'session'
    ? 'bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800'
    : 'bg-purple-50 dark:bg-purple-900/30 border-purple-200 dark:border-purple-800';
};
---

<Layout {meta}>
  <section class="relative">
    <div class="relative max-w-6xl mx-auto px-4 sm:px-6 mb-12 flex flex-col gap-4">
      <div class="pt-6 sm:pt-4 lg:pt-8">
        <div class="mb-6 md:mx-auto text-center max-w-3xl">
          <p class="text-base text-primary dark:text-blue-200 font-semibold tracking-wide uppercase">Archive</p>
          <h1 class="text-4xl md:text-5xl font-bold leading-tighter tracking-tighter mb-3 font-heading">
            Public Speaking
          </h1>
          <p class="max-w-3xl mx-auto sm:text-center text-lg text-muted dark:text-slate-400">
            {pageDescription}
          </p>
        </div>
      </div>

      {
        years.map((year) => (
          <div class="mb-14 flex flex-col">
            {/* Year header */}
            <h2 class="text-3xl font-bold mb-8 text-center">{year}</h2>

            <div class="timeline relative">
              {/* Timeline center line */}
              <div class="absolute h-full w-0.5 bg-gray-200 dark:bg-gray-700 left-1/2 transform -translate-x-1/2" />

              {sessionsByYear[year].map((session, index) => (
                <div
                  class={`timeline-item relative mb-8 ${index % 2 === 0 ? 'left-item' : 'right-item'} ${
                    index === 0 ? 'first-item' : ''
                  }`}
                >
                  {/* Timeline dot */}
                  <div class="absolute w-4 h-4 rounded-full bg-primary dark:bg-blue-400 left-1/2 transform -translate-x-1/2 z-10" />

                  {/* Timeline card */}
                  <div class={`session-card relative ${index % 2 === 0 ? 'mr-auto pr-8' : 'ml-auto pl-8'} w-5/12`}>
                    <div
                      class={`p-4 rounded-lg border ${getSessionColor(session.type)} shadow-sm ${
                        index % 2 === 0 ? 'text-right' : 'text-left'
                      }`}
                    >
                      {/* Date */}
                      <div class="font-medium text-gray-500 dark:text-gray-400 mb-1">
                        {formatDate(session.date)} <span class="text-lg">{session.language}</span>
                      </div>

                      {/* Title */}
                      <h3
                        class={`font-bold text-lg md:text-xl mb-2 break-words ${
                          index % 2 === 0 ? 'flex flex-row-reverse' : 'flex'
                        } items-center gap-2`}
                      >
                        {session.recording ? (
                          <a
                            href={session.recording}
                            target="_blank"
                            rel="noopener"
                            class={`text-primary dark:text-blue-400 hover:underline ${
                              index % 2 === 0 ? 'inline-flex flex-row-reverse' : 'inline-flex'
                            } flex-wrap items-center`}
                          >
                            <span>{session.title}</span>
                            <Icon
                              name="tabler:external-link"
                              class={`inline w-3 h-3 ${index % 2 === 0 ? 'mr-1' : 'ml-1'} flex-shrink-0`}
                            />
                          </a>
                        ) : (
                          <span class="break-words">{session.title}</span>
                        )}
                      </h3>

                      {/* Event */}
                      <div class="text-base text-gray-700 dark:text-gray-300 mb-3 break-words">
                        {session.eventUrl ? (
                          <a
                            href={session.eventUrl}
                            target="_blank"
                            rel="noopener"
                            class={`text-primary dark:text-blue-400 hover:underline ${
                              index % 2 === 0 ? 'inline-flex flex-row-reverse' : 'inline-flex'
                            } flex-wrap items-center`}
                          >
                            <span>{session.event}</span>
                            <Icon
                              name="tabler:external-link"
                              class={`inline w-3 h-3 ${index % 2 === 0 ? 'mr-1' : 'ml-1'} flex-shrink-0`}
                            />
                          </a>
                        ) : (
                          <span class="break-words">{session.event}</span>
                        )}
                      </div>

                      {/* Icons */}
                      <div
                        class={`${
                          index % 2 === 0 ? 'flex flex-row-reverse' : 'flex'
                        } items-center gap-3 text-gray-600 dark:text-gray-400`}
                      >
                        <div class="flex items-center gap-1" title={`Type: ${session.type}`}>
                          <Icon name={getSessionTypeIcon(session.type)} class="w-4 h-4" />
                          <span class="text-sm md:text-base capitalize">{session.type}</span>
                        </div>
                        <div class={'flex items-center gap-1'} title={`Mode: ${session.mode}`}>
                          <Icon name={getModeIcon(session.mode)} class="w-4 h-4" />
                          <span class="text-sm md:text-base capitalize">{session.mode}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))
      }
    </div>
  </section>
</Layout>

<style>
  /* Make sure the timeline is centered and responsive */
  .timeline {
    position: relative;
    min-height: 350px;
    padding-bottom: 40px; /* Add padding at bottom to account for overlaps */
  }

  /* Ensure cards are properly positioned */
  .timeline-item {
    position: relative;
    width: 100%;
    display: flex;
    margin-bottom: 20px; /* Reduced from 8 to allow for more overlap */
  }

  /* Add overlapping effects for both sides */
  .timeline-item:nth-child(odd) {
    margin-top: -60px; /* Apply overlap to odd items (left side) */
  }

  .timeline-item:nth-child(even) {
    margin-top: -60px; /* Keep the same overlap for even items (right side) */
  }

  /* Explicitly reset margin for the first item in each year group */
  .timeline-item.first-item {
    margin-top: 0 !important; /* Use !important to override other rules */
  }

  /* First-of-type selector as fallback */
  .timeline-item:first-of-type {
    margin-top: 0 !important;
  }

  /* Position the cards closer to the middle */
  .left-item .session-card,
  .right-item .session-card {
    width: 50%; /* Reduced from 5/12 (41.66%) to bring cards closer to middle */
  }

  /* Ensure each card has a higher z-index than the previous */
  .left-item .session-card::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 0;
    width: 8px;
    height: 2px;
    background-color: var(--color-primary);
    transform: translateY(-50%);
  }

  .right-item .session-card::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    width: 8px;
    height: 2px;
    background-color: var(--color-primary);
    transform: translateY(-50%);
  }

  /* Make timeline responsive */
  @media (max-width: 768px) {
    .timeline-item {
      flex-direction: column;
      align-items: flex-start;
    }

    /* Remove overlapping effect on mobile */
    .timeline-item:nth-child(odd),
    .timeline-item:nth-child(even) {
      margin-top: 0;
    }

    /* Reset z-index for mobile */
    .timeline-item {
      z-index: auto;
      margin-bottom: 20px; /* Restore regular spacing for mobile */
    }

    .left-item .session-card,
    .right-item .session-card {
      width: 85%;
      margin: 0 0 0 1.5rem;
      text-align: left;
      padding-left: 0.5rem;
    }

    /* Force left alignment for all content on mobile */
    .session-card div {
      text-align: left !important;
    }

    /* Reset all flex-row-reverse to normal flex on mobile */
    .session-card .flex-row-reverse {
      flex-direction: row !important;
    }

    /* Ensure links have correct icon placement on mobile */
    .session-card a .inline {
      margin-left: 0.25rem !important;
      margin-right: 0 !important;
    }

    .timeline .absolute {
      left: 0;
      transform: none;
    }

    .session-card::before,
    .session-card::after {
      display: none;
    }

    /* Move timeline to the left side for mobile */
    .timeline .absolute.h-full {
      left: 0;
      transform: none;
    }

    /* Fix for mobile: properly align the dots on the line */
    .timeline-item .absolute.w-4.h-4 {
      left: 6px; /* Same as the line position */
      transform: translateX(-1.5px); /* Adjusted to better center the dot on the line */
    }
  }
</style>
