---
import { AstroSeo } from '@astrolib/seo';

import { SITE } from '~/config.mjs';
import { type MetaSEO } from '~/types';
import { getRelativeUrlByFilePath } from '~/utils/directories';
import { getAsset, getCanonical } from '~/utils/permalinks';

import CustomStyles from '~/components/CustomStyles.astro';

export type Props = MetaSEO & {
  dontUseTitleTemplate?: boolean;
  publishDate?: Date;
  tags?: string[];
};

const defaultImage = SITE.defaultImage;

const {
  title = SITE.name,
  description = SITE.description,
  image: _image = defaultImage,

  canonical = getCanonical(String(Astro.url.pathname)),
  noindex = false,
  nofollow = false,

  ogType = 'website',

  author,

  dontUseTitleTemplate = false,
  languageAlternates,
  publishDate,
  tags,
} = Astro.props;

const pageTitle = `${title}${dontUseTitleTemplate ? '' : ` | ${SITE.name}`}`;

const image =
  typeof _image === 'string'
    ? new URL(_image, Astro.site)
    : _image && typeof _image['src'] !== 'undefined'
    ? // @ts-ignore
      new URL(getRelativeUrlByFilePath(_image.src), Astro.site)
    : null;

const analyticsId = SITE.googleAnalyticsId;
const collectAnalytics = SITE.collectAnalytics
---

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Preconnect to external resources for better performance -->
<link rel="preconnect" href="https://www.youtube.com" />
<link rel="preconnect" href="https://i.ytimg.com" />
<link rel="preconnect" href="https://www.googletagmanager.com" />
<link rel="dns-prefetch" href="https://www.youtube.com" />
<link rel="dns-prefetch" href="https://i.ytimg.com" />

<!-- Article meta tags for blog posts -->
{publishDate && <meta property="article:published_time" content={publishDate.toISOString()} />}
{publishDate && <meta property="article:modified_time" content={publishDate.toISOString()} />}
{tags && tags.map((tag) => <meta property="article:tag" content={tag} />)}

<AstroSeo
  title={pageTitle}
  titleTemplate={'%s'}
  description={description}
  canonical={String(canonical)}
  noindex={noindex}
  nofollow={nofollow}
  languageAlternates={languageAlternates}
  openGraph={{
    url: String(canonical),
    title: pageTitle,
    description: description,
    type: ogType,
    images: image
      ? [
          {
            url: image.toString(),
            alt: pageTitle,
            width: 1200,
            height: 630,
            type: 'image/png',
          },
        ]
      : undefined,
    site_name: pageTitle,
    article: {
      authors: [author ?? 'Leonardo Montini'],
    },
  }}
  twitter={{
    handle: '@balastrong',
    // site: '@site',
    cardType: image ? 'summary_large_image' : undefined,
  }}
/>

<CustomStyles />

<!-- Google Site Verification -->
{SITE.googleSiteVerificationId && <meta name="google-site-verification" content={SITE.googleSiteVerificationId} />}

<!-- Google Analytics -->
{
  collectAnalytics && (
    <>
      <script is:inline type="text/partytown" src={`https://www.googletagmanager.com/gtag/js?id=${analyticsId}`} ></script>
      <script is:inline type="text/partytown" define:vars={{ analyticsId }}>
        window.dataLayer = window.dataLayer || [];
        window.gtag = function gtag() {
          window.dataLayer.push(arguments);
        };
        window.gtag('js', new Date());
        window.gtag('config', String(analyticsId));
      </script>
  </>
  )
}

<link rel="icon" type="image/x-icon" href={getAsset('/favicon.ico')} />

<meta name="google-adsense-account" content="ca-pub-5878187781807536" />
